From 25fae431fd4584b3816ca3f317e5c2c1f4457839 Mon Sep 17 00:00:00 2001
From: Jeremy Gebben <jgebben@codeaurora.org>
Date: Fri, 27 Feb 2015 11:32:29 -0700
Subject: [PATCH] msm: kgsl: fix sync file error handling

We need to call put_unused_fd() on failure, but only if
a file hasn't been stored into the fd yet. This function
wasn't called from kgsl_ioctl_syncsource_create_fence()
and was called incorrectly from kgsl_add_fence_event().
Reorder our sync_fence_install() calls to happen after
all possible failures so that error cleanup will be
correct.

Conflicts:
	drivers/gpu/msm/kgsl_sync.c

Bug: 32125137
Change-Id: I57a75447d1a430de7e5a93d5cd103269fc0b1e15
Signed-off-by: Jeremy Gebben <jgebben@codeaurora.org>
---

diff --git a/drivers/gpu/msm/kgsl_sync.c b/drivers/gpu/msm/kgsl_sync.c
index af6aaaa..de1a008 100644
--- a/drivers/gpu/msm/kgsl_sync.c
+++ b/drivers/gpu/msm/kgsl_sync.c
@@ -173,7 +173,6 @@
 		ret = priv.fence_fd;
 		goto unlock;
 	}
-	sync_fence_install(fence, priv.fence_fd);
 
 	/* Unlock the mutex before copying to user */
 	kgsl_mutex_unlock(&device->mutex, &device->mutex_owner);
@@ -193,6 +192,8 @@
 	if (ret)
 		goto out;
 
+	sync_fence_install(fence, priv.fence_fd);
+
 	return 0;
 
 unlock:
