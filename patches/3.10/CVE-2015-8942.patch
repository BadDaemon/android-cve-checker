From ed8e5d017baddfa1e361eed33a52a85270a83338 Mon Sep 17 00:00:00 2001
From: Iliya Varadzhakov <ivarad@codeaurora.org>
Date: Fri, 13 Mar 2015 07:33:18 -0700
Subject: [PATCH] msm: cpp: Update iommu handling

CPP has to check for stream state before operate iommu
contexts.

Change-Id: I69e6266e1ff2d1cd93e7191f2c43c887154abae0
Signed-off-by: Iliya Varadzhakov <ivarad@codeaurora.org>
---

diff --git a/drivers/media/platform/msm/camera_v2/pproc/cpp/msm_cpp.c b/drivers/media/platform/msm/camera_v2/pproc/cpp/msm_cpp.c
index 1d7c2a7..b76ee2d 100644
--- a/drivers/media/platform/msm/camera_v2/pproc/cpp/msm_cpp.c
+++ b/drivers/media/platform/msm/camera_v2/pproc/cpp/msm_cpp.c
@@ -2319,7 +2319,8 @@
 		break;
 	}
 	case VIDIOC_MSM_CPP_IOMMU_DETACH: {
-		if (cpp_dev->iommu_state == CPP_IOMMU_STATE_ATTACHED) {
+		if ((cpp_dev->iommu_state == CPP_IOMMU_STATE_ATTACHED) &&
+			(cpp_dev->stream_cnt == 0)) {
 			iommu_detach_device(cpp_dev->domain,
 				cpp_dev->iommu_ctx);
 			cpp_dev->iommu_state = CPP_IOMMU_STATE_DETACHED;
